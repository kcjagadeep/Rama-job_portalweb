{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TTS Engine Testing Lab</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .metric-card { background: #f8f9fa; border-radius: 8px; padding: 20px; text-align: center; }
        .metric-value { font-size: 2rem; font-weight: bold; color: #007bff; }
        .model-card { border: 2px solid #ddd; border-radius: 8px; padding: 15px; cursor: pointer; transition: all 0.3s; }
        .model-card:hover, .model-card.selected { border-color: #007bff; background: #f8f9ff; }
        .chat-container { height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: #fff; }
        .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; }
        .user-message { background: #007bff; color: white; margin-left: 20%; }
        .agent-message { background: #e9ecef; margin-right: 20%; }
        .latency-bar { height: 20px; background: linear-gradient(90deg, #28a745, #ffc107, #dc3545); border-radius: 10px; position: relative; overflow: hidden; }
        .latency-indicator { position: absolute; top: 0; left: 0; height: 100%; background: rgba(255,255,255,0.8); transition: width 0.3s; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-online { background: #28a745; }
        .status-offline { background: #dc3545; }
        .voice-recording { background: #dc3545 !important; animation: pulse 1s infinite; }
        .voice-processing { background: #ffc107 !important; }
        #latencyChart { border: 1px solid #ddd; border-radius: 4px; }
        .call-interface { padding: 20px; }
        .call-avatar { width: 80px; height: 80px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; }
        .call-avatar i { font-size: 2rem; color: white; }
        .call-avatar.active { animation: pulse 2s infinite; background: #28a745; }
        .call-btn { width: 80px; height: 80px; font-size: 1.5rem; }
        .call-btn.active { background: #dc3545; border-color: #dc3545; animation: pulse 1s infinite; }
        .call-btn.connecting { background: #ffc107; border-color: #ffc107; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="container-fluid py-4">
        <h1 class="text-center mb-4"><i class="fas fa-microphone-alt"></i> TTS Engine Testing Lab</h1>
        
        <!-- Token Management -->
        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-key"></i> API Token</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <input type="text" id="apiToken" class="form-control" placeholder="Enter API Token">
                    </div>
                    <div class="col-md-4">
                        <button id="generateToken" class="btn btn-primary w-100">Generate Token</button>
                    </div>
                </div>
                <div class="mt-2">
                    <span class="status-dot status-offline" id="tokenStatus"></span>
                    <span id="tokenStatusText">Token not configured</span>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Model & Voice Selection -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header"><h5>TTS Models</h5></div>
                    <div class="card-body">
                        <div id="modelsContainer">
                            <div class="text-muted">Loading models from API...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header"><h5>Voice Selection</h5></div>
                    <div class="card-body">
                        <div id="voicesContainer">
                            <div class="text-muted">Loading voices from API...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metrics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="latencyValue">0ms</div>
                    <div>Average Latency</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="successRate">100%</div>
                    <div>Success Rate</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="totalRequests">0</div>
                    <div>Total Requests</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="metric-card">
                    <div class="metric-value" id="audioQuality">High</div>
                    <div>Audio Quality</div>
                </div>
            </div>
        </div>

        <!-- TTS Testing -->
        <div class="card mb-4">
            <div class="card-header"><h5><i class="fas fa-microphone"></i> TTS Testing</h5></div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <textarea id="testText" class="form-control" rows="3" placeholder="Enter text to convert to speech...">Hello! I'm testing the TTS engine with different voice models.</textarea>
                    </div>
                    <div class="col-md-4">
                        <button id="generateSpeech" class="btn btn-success w-100 mb-2">
                            <i class="fas fa-volume-up"></i> Generate Speech
                        </button>
                        <button id="playGenerated" class="btn btn-info w-100" disabled>
                            <i class="fas fa-play"></i> Play Audio
                        </button>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="latency-bar">
                        <div class="latency-indicator" id="latencyBar"></div>
                    </div>
                    <small class="text-muted">Latency: <span id="currentLatency">0ms</span></small>
                </div>
            </div>
        </div>

        <!-- Real-time Agent -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-phone"></i> Real-time Voice Call Agent</h5>
                <!-- Model & Voice Display -->
                <div class="row mt-2">
                    <div class="col-md-6">
                        <small class="text-muted">ðŸ¤– AI Model:</small><br>
                        <span class="badge bg-primary" id="currentModel">nvidia/llama-3.3-nemotron-super-49b-v1</span>
                    </div>
                    <div class="col-md-6">
                        <small class="text-muted">ðŸ”Š Voice:</small><br>
                        <span class="badge bg-success" id="currentVoice">Daisy Studious (Female)</span>
                    </div>
                </div>
            </div>
            <div class="card-body text-center">
                <div class="call-interface">
                    <div class="call-status mb-4">
                        <div class="call-avatar">
                            <i class="fas fa-robot" id="callAvatar"></i>
                        </div>
                        <h4 id="callStatusText">Ready to Call</h4>
                        <p class="text-muted" id="callSubtext">Press the button below to start talking</p>
                    </div>
                    
                    <div class="call-controls mb-4">
                        <button id="callButton" class="btn btn-success btn-lg rounded-circle call-btn">
                            <i class="fas fa-phone" id="callIcon"></i>
                        </button>
                    </div>
                    
                    <div class="call-info">
                        <div class="row">
                            <div class="col-md-3">
                                <small class="text-muted">Status:</small><br>
                                <span id="connectionStatus">Disconnected</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Duration:</small><br>
                                <span id="callDuration">00:00</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Mic Status:</small><br>
                                <span id="micStatus">ðŸŽ¤ Ready</span>
                            </div>
                            <div class="col-md-3">
                                <small class="text-muted">Quality:</small><br>
                                <span id="callQuality">High</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden chat for transcript -->
                <div class="chat-container mt-4" id="chatContainer" style="height: 200px; display: none;">
                    <div class="message agent-message">
                        <strong>AI Agent:</strong> Hello! I'm ready to talk with you.
                    </div>
                </div>
                
                <div class="mt-3">
                    <button id="showTranscript" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-eye"></i> Show Transcript
                    </button>
                </div>
            </div>
        </div>

        <!-- Conversation Analytics -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Conversation Analytics</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avgConversationLatency">0ms</div>
                            <div>Avg Conversation Latency</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="speechRecognitionTime">0ms</div>
                            <div>Speech Recognition</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="llmResponseTime">0ms</div>
                            <div>LLM Response</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="ttsGenerationTime">0ms</div>
                            <div>TTS Generation</div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <canvas id="latencyChart" width="400" height="100"></canvas>
                </div>
            </div>
        </div>

        <audio id="audioPlayer" controls class="w-100 mt-3" style="display: none;"></audio>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class TTSLab {
            constructor() {
                this.apiToken = '';
                this.selectedModel = 'default';
                this.selectedVoice = 'default';
                this.metrics = { totalRequests: 0, successfulRequests: 0, totalLatency: 0 };
                this.agentActive = false;
                this.recognition = null;
                this.isRecording = false;
                this.conversationMetrics = [];
                this.latencyChart = null;
                this.callActive = false;
                this.callStartTime = null;
                this.callTimer = null;
                this.continuousListening = false;
                this.lastConversationMetrics = null;
                this.init();
            }

            init() {
                this.bindEvents();
                this.loadModelsAndVoices();
                this.initSpeechRecognition();
                this.initLatencyChart();
            }

            bindEvents() {
                document.getElementById('generateToken').onclick = () => this.generateToken();
                document.getElementById('generateSpeech').onclick = () => this.generateSpeech();
                document.getElementById('playGenerated').onclick = () => this.playAudio();
                document.getElementById('callButton').onclick = () => this.toggleCall();
                document.getElementById('showTranscript').onclick = () => this.toggleTranscript();
                


                document.getElementById('apiToken').oninput = (e) => {
                    this.apiToken = e.target.value;
                    this.validateToken();
                };

                document.querySelectorAll('.model-card[data-model]').forEach(card => {
                    card.onclick = () => this.selectModel(card.dataset.model);
                });

                document.querySelectorAll('.model-card[data-voice]').forEach(card => {
                    card.onclick = () => this.selectVoice(card.dataset.voice);
                });
            }

            async generateToken() {
                try {
                    const response = await fetch('/tts/generate-token/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() }
                    });
                    const data = await response.json();
                    if (data.success) {
                        this.apiToken = data.token;
                        document.getElementById('apiToken').value = this.apiToken;
                        this.updateTokenStatus(true, 'Token generated');
                        
                        // Update models and voices from token response
                        console.log('Models array:', data.models);
                        console.log('Voices array:', data.voices);
                        
                        if (data.models && data.models.length > 0) {
                            this.updateModelsUI(data.models);
                            setTimeout(() => this.selectModel(data.models[0].id), 100);
                        }
                        if (data.voices && data.voices.length > 0) {
                            this.updateVoicesUI(data.voices);
                            setTimeout(() => this.selectVoice(data.voices[0].id), 100);
                        }
                    }
                } catch (error) {
                    this.updateTokenStatus(false, 'Token generation failed');
                }
            }

            async generateSpeech() {
                const text = document.getElementById('testText').value.trim();
                if (!text) return alert('Please enter text');

                const startTime = Date.now();
                const btn = document.getElementById('generateSpeech');
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';

                try {
                    const response = await fetch('/tts/generate-speech/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() },
                        body: JSON.stringify({
                            text: text,
                            model: this.selectedModel,
                            voice: this.selectedVoice,
                            token: this.apiToken
                        })
                    });

                    const data = await response.json();
                    const latency = Date.now() - startTime;

                    this.updateMetrics(latency, data.success);
                    
                    if (data.success) {
                        document.getElementById('audioPlayer').src = data.audio_url;
                        document.getElementById('audioPlayer').style.display = 'block';
                        document.getElementById('playGenerated').disabled = false;
                    } else {
                        alert('Generation failed: ' + data.error);
                    }
                } catch (error) {
                    this.updateMetrics(Date.now() - startTime, false);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-volume-up"></i> Generate Speech';
                }
            }

            async processVoiceMessage(message) {
                if (!message || !this.agentActive) return;

                const conversationStart = Date.now();
                const speechRecognitionTime = this.lastSpeechRecognitionTime || 0;

                try {
                    const llmStart = Date.now();
                    const response = await fetch('/tts/chat/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() },
                        body: JSON.stringify({
                            message: message,
                            model: 'nvidia/llama-3.3-nemotron-super-49b-v1',
                            voice: this.selectedVoice,
                            auto_speak: true
                        })
                    });

                    const data = await response.json();
                    
                    if (data.success) {
                        const llmResponseTime = data.llm_latency || (Date.now() - llmStart);
                        
                        this.addMessage('agent', data.response);
                        
                        // Update model display
                        document.getElementById('currentModel').textContent = data.model_used || 'nvidia/llama-3.3-nemotron-super-49b-v1';
                        
                        // Update LLM latency immediately
                        document.getElementById('llmResponseTime').textContent = llmResponseTime + 'ms';
                        
                        // Always speak in call mode
                        if (this.callActive) {
                            await this.speakText(data.response);
                        }

                        const totalLatency = Date.now() - conversationStart;
                        this.lastConversationMetrics = {
                            totalLatency,
                            speechRecognitionTime,
                            llmResponseTime,
                            ttsGenerationTime: 0
                        };
                    } else {
                        this.addMessage('agent', 'Sorry, AI service is unavailable.');
                    }

                } catch (error) {
                    this.addMessage('agent', 'Sorry, I encountered a connection error.');
                    console.error('LLM Error:', error);
                }
            }

            addMessage(type, content) {
                const messageClass = type === 'user' ? 'user-message' : 'agent-message';
                const sender = type === 'user' ? 'You' : 'AI Agent';
                
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${messageClass}`;
                messageDiv.innerHTML = `<strong>${sender}:</strong> ${content}`;
                
                document.getElementById('chatContainer').appendChild(messageDiv);
                document.getElementById('chatContainer').scrollTop = document.getElementById('chatContainer').scrollHeight;
            }

            toggleCall() {
                if (!this.callActive) {
                    this.startCall();
                } else {
                    this.endCall();
                }
            }

            startCall() {
                if (!this.apiToken) {
                    alert('Please generate an API token first');
                    return;
                }
                
                this.callActive = true;
                this.callStartTime = Date.now();
                this.agentActive = true;
                this.continuousListening = true;
                
                // Update UI
                document.getElementById('callButton').className = 'btn btn-danger btn-lg rounded-circle call-btn active';
                document.getElementById('callIcon').className = 'fas fa-phone-slash';
                document.getElementById('callStatusText').textContent = 'Connected';
                document.getElementById('callSubtext').textContent = 'Speak naturally - I\'m listening';
                document.getElementById('connectionStatus').textContent = 'Connected';
                document.getElementById('micStatus').innerHTML = 'ðŸŽ¤ Active';
                document.getElementById('callAvatar').parentElement.classList.add('active');
                
                // Update model/voice display
                document.getElementById('currentModel').textContent = this.selectedModel || 'nvidia/llama-3.3-nemotron-super-49b-v1';
                document.getElementById('currentVoice').textContent = this.selectedVoice || 'Daisy Studious (Female)';
                
                // Start call timer
                this.callTimer = setInterval(() => this.updateCallDuration(), 1000);
                
                // Start continuous listening
                this.startContinuousListening();
                
                // Welcome message
                this.addMessage('agent', 'Hello! I\'m connected and ready to talk. What would you like to discuss?');
                this.speakText('Hello! I\'m connected and ready to talk. What would you like to discuss?');
            }

            endCall() {
                this.callActive = false;
                this.agentActive = false;
                this.continuousListening = false;
                
                // Stop recognition
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
                
                // Update UI
                document.getElementById('callButton').className = 'btn btn-success btn-lg rounded-circle call-btn';
                document.getElementById('callIcon').className = 'fas fa-phone';
                document.getElementById('callStatusText').textContent = 'Call Ended';
                document.getElementById('callSubtext').textContent = 'Press to call again';
                document.getElementById('connectionStatus').textContent = 'Disconnected';
                document.getElementById('micStatus').innerHTML = 'ðŸ”‡ Muted';
                document.getElementById('callAvatar').parentElement.classList.remove('active');
                
                // Stop timer
                if (this.callTimer) {
                    clearInterval(this.callTimer);
                    this.callTimer = null;
                }
                
                // Goodbye message
                this.addMessage('agent', 'Call ended. Thanks for talking with me!');
                
                setTimeout(() => {
                    document.getElementById('callStatusText').textContent = 'Ready to Call';
                    document.getElementById('callSubtext').textContent = 'Press the button below to start talking';
                    document.getElementById('callDuration').textContent = '00:00';
                    document.getElementById('micStatus').innerHTML = 'ðŸŽ¤ Ready';
                }, 3000);
            }

            async selectModel(model) {
                this.selectedModel = model;
                document.querySelectorAll('.model-card[data-model]').forEach(card => {
                    card.classList.remove('selected');
                });
                const modelCard = document.querySelector(`[data-model="${model}"]`);
                if (modelCard) {
                    modelCard.classList.add('selected');
                }
                
                // Load voices for selected model
                await this.loadVoicesForModel(model);
            }

            selectVoice(voice) {
                this.selectedVoice = voice;
                document.querySelectorAll('.model-card[data-voice]').forEach(card => {
                    card.classList.remove('selected');
                });
                const voiceCard = document.querySelector(`[data-voice="${voice}"]`);
                if (voiceCard) {
                    voiceCard.classList.add('selected');
                }
            }

            updateMetrics(latency, success) {
                this.metrics.totalRequests++;
                if (success) this.metrics.successfulRequests++;
                this.metrics.totalLatency += latency;
                
                const avgLatency = Math.round(this.metrics.totalLatency / this.metrics.totalRequests);
                const successRate = Math.round((this.metrics.successfulRequests / this.metrics.totalRequests) * 100);
                
                document.getElementById('latencyValue').textContent = avgLatency + 'ms';
                document.getElementById('successRate').textContent = successRate + '%';
                document.getElementById('totalRequests').textContent = this.metrics.totalRequests;
                document.getElementById('currentLatency').textContent = latency + 'ms';
                
                const percentage = Math.min((latency / 5000) * 100, 100);
                document.getElementById('latencyBar').style.width = percentage + '%';
            }

            updateTokenStatus(isValid, message) {
                const statusDot = document.getElementById('tokenStatus');
                statusDot.className = `status-dot ${isValid ? 'status-online' : 'status-offline'}`;
                document.getElementById('tokenStatusText').textContent = message;
            }

            validateToken() {
                this.updateTokenStatus(this.apiToken.length > 10, 
                    this.apiToken.length > 10 ? 'Token configured' : 'Token not configured');
            }

            playAudio() {
                document.getElementById('audioPlayer').play();
            }

            initSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';

                    this.recognition.onstart = () => {
                        this.speechRecognitionStart = Date.now();
                        if (document.getElementById('micStatus')) {
                            document.getElementById('micStatus').innerHTML = 'ðŸŽ¤ Listening...';
                        }
                    };

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript.trim();
                        if (transcript.length < 3) return; // Ignore very short utterances
                        
                        this.lastSpeechRecognitionTime = Date.now() - this.speechRecognitionStart;
                        
                        // Add user message and process
                        this.addMessage('user', transcript);
                        this.processVoiceMessage(transcript);
                    };

                    this.recognition.onerror = () => {
                        if (document.getElementById('micStatus')) {
                            document.getElementById('micStatus').innerHTML = 'âŒ Error';
                        }
                    };

                    this.recognition.onend = () => {
                        this.isRecording = false;
                        
                        // Restart listening if in continuous mode
                        if (this.continuousListening && this.callActive) {
                            setTimeout(() => {
                                this.startContinuousListening();
                            }, 1000);
                        }
                    };
                } else {
                    document.getElementById('voiceInput').disabled = true;
                    document.getElementById('voiceInput').textContent = 'Voice not supported';
                }
            }

            startContinuousListening() {
                if (!this.recognition || !this.continuousListening) return;
                
                if (!this.isRecording) {
                    this.isRecording = true;
                    this.recognition.start();
                }
            }

            updateCallDuration() {
                if (!this.callStartTime) return;
                
                const duration = Math.floor((Date.now() - this.callStartTime) / 1000);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                
                document.getElementById('callDuration').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            toggleTranscript() {
                const container = document.getElementById('chatContainer');
                const button = document.getElementById('showTranscript');
                
                if (container.style.display === 'none') {
                    container.style.display = 'block';
                    button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Transcript';
                } else {
                    container.style.display = 'none';
                    button.innerHTML = '<i class="fas fa-eye"></i> Show Transcript';
                }
            }

            async speakText(text) {
                if (!this.callActive) return;
                
                // Mute microphone during AI speech
                document.getElementById('micStatus').innerHTML = 'ðŸ”‡ Muted (AI Speaking)';
                if (this.recognition && this.isRecording) {
                    this.recognition.stop();
                }
                
                try {
                    const ttsStart = Date.now();
                    const response = await fetch('/tts/generate-speech/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': this.getCSRFToken() },
                        body: JSON.stringify({
                            text: text,
                            model: this.selectedModel,
                            voice: this.selectedVoice,
                            token: this.apiToken
                        })
                    });
                    
                    const data = await response.json();
                    const ttsLatency = Date.now() - ttsStart;
                    
                    if (data.success) {
                        const audio = document.getElementById('audioPlayer');
                        audio.src = data.audio_url;
                        
                        audio.onended = () => {
                            // Unmute microphone after AI finishes speaking
                            document.getElementById('micStatus').innerHTML = 'ðŸŽ¤ Active';
                            if (this.callActive) {
                                setTimeout(() => this.startContinuousListening(), 500);
                            }
                        };
                        
                        await audio.play();
                        
                        // Update TTS metrics in conversation analytics
                        document.getElementById('ttsGenerationTime').textContent = ttsLatency + 'ms';
                        
                        // Update conversation metrics with TTS latency
                        if (this.lastConversationMetrics) {
                            this.lastConversationMetrics.ttsGenerationTime = ttsLatency;
                            this.updateConversationMetrics(this.lastConversationMetrics);
                        }
                    }
                } catch (error) {
                    console.error('TTS failed:', error);
                    // Unmute on error
                    document.getElementById('micStatus').innerHTML = 'ðŸŽ¤ Active';
                    if (this.callActive) {
                        setTimeout(() => this.startContinuousListening(), 500);
                    }
                }
            }

            initLatencyChart() {
                const canvas = document.getElementById('latencyChart');
                const ctx = canvas.getContext('2d');
                this.latencyChart = { canvas, ctx };
                this.drawLatencyChart();
            }

            drawLatencyChart() {
                const { ctx, canvas } = this.latencyChart;
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                if (this.conversationMetrics.length === 0) {
                    ctx.fillStyle = '#666';
                    ctx.font = '14px Arial';
                    ctx.textAlign = 'center';
                    ctx.fillText('No conversation data yet', canvas.width / 2, canvas.height / 2);
                    return;
                }

                const maxLatency = Math.max(...this.conversationMetrics.map(m => m.totalLatency));
                const barWidth = canvas.width / Math.max(this.conversationMetrics.length, 10);
                
                this.conversationMetrics.forEach((metric, index) => {
                    const barHeight = (metric.totalLatency / maxLatency) * (canvas.height - 20);
                    const x = index * barWidth;
                    const y = canvas.height - barHeight - 10;
                    
                    ctx.fillStyle = metric.totalLatency > 3000 ? '#dc3545' : 
                                   metric.totalLatency > 1500 ? '#ffc107' : '#28a745';
                    ctx.fillRect(x, y, barWidth - 2, barHeight);
                });
            }

            updateConversationMetrics(metrics) {
                // Update total latency to include TTS time
                metrics.totalLatency = metrics.speechRecognitionTime + metrics.llmResponseTime + metrics.ttsGenerationTime;
                
                this.conversationMetrics.push(metrics);
                if (this.conversationMetrics.length > 20) {
                    this.conversationMetrics.shift();
                }

                const avgTotal = Math.round(this.conversationMetrics.reduce((sum, m) => sum + m.totalLatency, 0) / this.conversationMetrics.length);
                const avgSpeech = Math.round(this.conversationMetrics.reduce((sum, m) => sum + m.speechRecognitionTime, 0) / this.conversationMetrics.length);
                const avgLLM = Math.round(this.conversationMetrics.reduce((sum, m) => sum + m.llmResponseTime, 0) / this.conversationMetrics.length);
                const avgTTS = Math.round(this.conversationMetrics.reduce((sum, m) => sum + m.ttsGenerationTime, 0) / this.conversationMetrics.length);

                document.getElementById('avgConversationLatency').textContent = avgTotal + 'ms';
                document.getElementById('speechRecognitionTime').textContent = avgSpeech + 'ms';
                document.getElementById('llmResponseTime').textContent = avgLLM + 'ms';
                document.getElementById('ttsGenerationTime').textContent = avgTTS + 'ms';

                this.drawLatencyChart();
            }

            async loadModelsAndVoices() {
                try {
                    const response = await fetch('/tts/models/');
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateModelsUI(data.models);
                        this.updateVoicesUI(data.voices);
                    }
                } catch (error) {
                    console.error('Failed to load models and voices:', error);
                }
            }

            updateModelsUI(models) {
                const container = document.getElementById('modelsContainer');
                container.innerHTML = '';
                
                if (!models || models.length === 0) {
                    container.innerHTML = '<div class="text-muted">No models available from API</div>';
                    return;
                }
                
                models.forEach(model => {
                    const div = document.createElement('div');
                    div.className = 'model-card mb-2';
                    div.dataset.model = model.id;
                    div.innerHTML = `
                        <h6>${model.name}</h6>
                        <small class="text-muted">${model.description}</small>
                    `;
                    div.onclick = () => this.selectModel(model.id);
                    container.appendChild(div);
                });
            }

            updateVoicesUI(voices) {
                const container = document.getElementById('voicesContainer');
                container.innerHTML = '';
                
                if (!voices || voices.length === 0) {
                    container.innerHTML = '<div class="text-muted">No voices available from API</div>';
                    return;
                }
                
                voices.forEach(voice => {
                    const div = document.createElement('div');
                    div.className = 'model-card mb-2';
                    div.dataset.voice = voice.id;
                    div.innerHTML = `
                        <h6>${voice.name}</h6>
                        <small class="text-muted">${voice.gender} - ${voice.style}</small>
                    `;
                    div.onclick = () => this.selectVoice(voice.id);
                    container.appendChild(div);
                });
            }

            async loadVoicesForModel(modelId) {
                try {
                    const response = await fetch(`/tts/voices/?model=${modelId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        this.updateVoicesUI(data.voices);
                        // Auto-select first voice
                        if (data.voices && data.voices.length > 0) {
                            setTimeout(() => this.selectVoice(data.voices[0].id), 100);
                        }
                    } else {
                        document.getElementById('voicesContainer').innerHTML = '<div class="text-muted">No voices available for this model</div>';
                    }
                } catch (error) {
                    console.error('Failed to load voices for model:', error);
                    document.getElementById('voicesContainer').innerHTML = '<div class="text-muted">Error loading voices</div>';
                }
            }

            getCSRFToken() {
                const token = document.querySelector('[name=csrfmiddlewaretoken]');
                return token ? token.value : '';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            window.ttsLab = new TTSLab();
        });
    </script>
</body>
</html>