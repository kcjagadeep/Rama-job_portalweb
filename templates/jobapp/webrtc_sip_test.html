<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC SIP Test - Voice Agent</title>
    {% load static %}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://unpkg.com/jssip@3.10.1/dist/jssip.min.js"></script>
    <style>
        .webrtc-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
        }
        
        .dialer-pad {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .number-display {
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            font-size: 24px;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            width: 100%;
        }
        
        .dial-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 20px;
            font-weight: bold;
            margin: 5px;
            transition: all 0.3s ease;
        }
        
        .dial-btn:hover {
            background: rgba(255,255,255,0.2);
            transform: scale(1.1);
        }
        
        .call-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: none;
            font-size: 24px;
            margin: 10px;
            transition: all 0.3s ease;
        }
        
        .call-btn.call {
            background: #28a745;
            color: white;
        }
        
        .call-btn.hangup {
            background: #dc3545;
            color: white;
        }
        
        .status-indicator {
            padding: 10px 20px;
            border-radius: 25px;
            margin: 10px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status-ready { background: rgba(40, 167, 69, 0.3); }
        .status-calling { background: rgba(255, 193, 7, 0.3); animation: pulse 1.5s infinite; }
        .status-connected { background: rgba(40, 167, 69, 0.5); }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="webrtc-container">
            <div class="text-center mb-4">
                <h1><i class="fas fa-phone-alt"></i> WebRTC SIP Test</h1>
                <p class="lead">Real-time Voice Calls with WebRTC</p>
                <div class="alert alert-info">
                    <i class="fas fa-server"></i> 
                    <strong id="connectionStatus">Connecting...</strong>
                </div>
            </div>
            
            <div class="status-indicator status-ready" id="callStatus">
                <i class="fas fa-circle"></i> Ready to call
            </div>
            
            <div class="dialer-pad">
                <input type="text" class="number-display" id="numberDisplay" placeholder="Enter phone number">
                
                <div class="text-center">
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <button class="dial-btn" onclick="addDigit('1')">1</button>
                            <button class="dial-btn" onclick="addDigit('2')">2</button>
                            <button class="dial-btn" onclick="addDigit('3')">3</button>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <button class="dial-btn" onclick="addDigit('4')">4</button>
                            <button class="dial-btn" onclick="addDigit('5')">5</button>
                            <button class="dial-btn" onclick="addDigit('6')">6</button>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <button class="dial-btn" onclick="addDigit('7')">7</button>
                            <button class="dial-btn" onclick="addDigit('8')">8</button>
                            <button class="dial-btn" onclick="addDigit('9')">9</button>
                        </div>
                    </div>
                    <div class="row justify-content-center">
                        <div class="col-auto">
                            <button class="dial-btn" onclick="addDigit('*')">*</button>
                            <button class="dial-btn" onclick="addDigit('0')">0</button>
                            <button class="dial-btn" onclick="addDigit('#')">#</button>
                        </div>
                    </div>
                </div>
                
                <div class="text-center mt-3">
                    <button class="call-btn call" id="callBtn" onclick="makeCall()">
                        <i class="fas fa-phone"></i>
                    </button>
                    <button class="call-btn hangup" id="hangupBtn" onclick="hangupCall()" style="display: none;">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                    <button class="dial-btn" onclick="clearNumber()" style="background: rgba(220, 53, 69, 0.3);">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ua = null;
        let currentSession = null;
        let sipConfig = null;
        
        // Initialize WebRTC SIP
        async function initWebRTC() {
            try {
                const response = await fetch('/webrtc/config/');
                const data = await response.json();
                
                if (data.success) {
                    sipConfig = data.config;
                    document.getElementById('connectionStatus').textContent = data.status;
                    
                    // Initialize JsSIP with VoxBay WebRTC
                    const socket = new JsSIP.WebSocketInterface(sipConfig.websocket_url);
                    const configuration = {
                        sockets: [socket],
                        uri: `sip:${sipConfig.username}@${sipConfig.domain}`,
                        password: sipConfig.password,
                        display_name: sipConfig.username,
                        register: true
                    };
                    
                    ua = new JsSIP.UA(configuration);
                    
                    ua.on('connected', () => {
                        document.getElementById('connectionStatus').textContent = 
                            `Connected to ${sipConfig.domain}:${sipConfig.port}`;
                        updateCallStatus('ready', 'Ready to call');
                    });
                    
                    ua.on('disconnected', () => {
                        document.getElementById('connectionStatus').textContent = 'Disconnected';
                        updateCallStatus('ready', 'Connection lost');
                    });
                    
                    ua.on('registrationFailed', (e) => {
                        console.error('Registration failed:', e);
                        document.getElementById('connectionStatus').textContent = 'Registration failed - Check credentials';
                        
                        // Try alternative WebSocket URLs
                        const altUrls = [
                            `ws://${sipConfig.domain}:${sipConfig.port}`,
                            `wss://${sipConfig.domain}:7443`,
                            `ws://${sipConfig.domain}:8088`
                        ];
                        
                        console.log('Trying alternative URLs:', altUrls);
                    });
                    
                    ua.on('registered', () => {
                        document.getElementById('connectionStatus').textContent = 
                            `Registered to ${sipConfig.domain}`;
                    });
                    
                    ua.on('newRTCSession', (e) => {
                        currentSession = e.session;
                        
                        currentSession.on('accepted', () => {
                            updateCallStatus('connected', 'Call connected');
                            document.getElementById('callBtn').style.display = 'none';
                            document.getElementById('hangupBtn').style.display = 'inline-block';
                        });
                        
                        currentSession.on('ended', () => {
                            updateCallStatus('ready', 'Call ended');
                            document.getElementById('callBtn').style.display = 'inline-block';
                            document.getElementById('hangupBtn').style.display = 'none';
                            currentSession = null;
                        });
                    });
                    
                    ua.start();
                }
            } catch (error) {
                console.error('WebRTC initialization failed:', error);
                document.getElementById('connectionStatus').textContent = 'Connection failed';
            }
        }
        
        function addDigit(digit) {
            document.getElementById('numberDisplay').value += digit;
        }
        
        function clearNumber() {
            const display = document.getElementById('numberDisplay');
            if (display.value.length > 0) {
                display.value = display.value.slice(0, -1);
            }
        }
        
        function makeCall() {
            const number = document.getElementById('numberDisplay').value.trim();
            
            if (!number) {
                alert('Please enter a phone number');
                return;
            }
            
            if (!ua || !ua.isConnected()) {
                alert('Not connected to SIP server');
                return;
            }
            
            try {
                updateCallStatus('calling', `Calling ${number}...`);
                
                const eventHandlers = {
                    'progress': () => {
                        updateCallStatus('calling', 'Ringing...');
                    },
                    'failed': () => {
                        updateCallStatus('ready', 'Call failed');
                    }
                };
                
                const options = {
                    eventHandlers: eventHandlers,
                    mediaConstraints: { audio: true, video: false }
                };
                
                ua.call(`sip:${number}@${sipConfig.domain}`, options);
                
            } catch (error) {
                console.error('Call failed:', error);
                updateCallStatus('ready', 'Call failed');
            }
        }
        
        function hangupCall() {
            if (currentSession) {
                currentSession.terminate();
            }
        }
        
        function updateCallStatus(status, message) {
            const statusEl = document.getElementById('callStatus');
            statusEl.className = `status-indicator status-${status}`;
            
            let icon = 'fas fa-circle';
            if (status === 'calling') icon = 'fas fa-phone-alt';
            else if (status === 'connected') icon = 'fas fa-phone';
            
            statusEl.innerHTML = `<i class="${icon}"></i> ${message}`;
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initWebRTC);
        
        // Keyboard support
        document.addEventListener('keydown', (event) => {
            const key = event.key;
            if ('0123456789*#'.includes(key)) {
                addDigit(key);
            } else if (key === 'Backspace') {
                clearNumber();
            } else if (key === 'Enter') {
                if (currentSession) {
                    hangupCall();
                } else {
                    makeCall();
                }
            }
        });
    </script>
</body>
</html>